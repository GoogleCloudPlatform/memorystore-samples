# Copyright 2025 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: leaderboard-app-with-data

services:
 valkey:
   image: valkey/valkey:latest
   container_name: leaderboard-valkey
   ports:
     - "6379:6379"
   command: ["valkey-server", "--save", "60", "1", "--loglevel", "warning"]
   healthcheck:
     test: ["CMD", "valkey-cli", "ping"]
     interval: 5s
     timeout: 3s
     retries: 5

 postgres:
   image: postgres:latest
   container_name: leaderboard-postgres-sample-data
   ports:
     - "5432:5432"
   environment:
     - POSTGRES_USER=admin
     - POSTGRES_PASSWORD=password
     - POSTGRES_DB=postgres
   volumes:
     - ../app/init.sql:/docker-entrypoint-initdb.d/init.sql
   healthcheck:
     test: ["CMD-SHELL", "pg_isready -U admin -d postgres"]
     interval: 5s
     timeout: 5s
     retries: 5

 seed-data:
   build:
     context: .
     dockerfile: Dockerfile
   container_name: leaderboard-seed-data
   depends_on:
     postgres:
       condition: service_healthy
   environment:
     - DB_URL=jdbc:postgresql://leaderboard-postgres-sample-data:5432/postgres
     - DB_USERNAME=admin
     - DB_PASSWORD=password
   # Runs once and exits
   restart: "no"
   # Remove the container after it exits for clean re-runs
   labels:
     - "com.docker.compose.oneshot=true"

 app:
   build:
     context: ../app
     dockerfile: Dockerfile
   container_name: leaderboard-app
   ports:
     - "8080:8080"
   depends_on:
     postgres:
       condition: service_healthy
     valkey:
       condition: service_healthy
     # Note: NOT depending on seed-data
   environment:
     - VALKEY_HOST=valkey
     - VALKEY_PORT=6379
     - DB_URL=jdbc:postgresql://leaderboard-postgres-sample-data:5432/postgres
     - DB_USERNAME=admin
     - DB_PASSWORD=password
   healthcheck:
     test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
     interval: 30s
     timeout: 10s
     retries: 3
     start_period: 40s